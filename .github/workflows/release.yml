name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to use when manually triggering'
        required: false

jobs:
  build-release:
    # Run on your self-hosted Windows runner. Labels can be adjusted to match your runner's labels.
    runs-on: [self-hosted, windows]
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Determine version
        id: set_version
        shell: pwsh
        run: |
          $version = $null
          if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $version = $matches[1] }
          elseif ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $payload = Get-Content $env:GITHUB_EVENT_PATH | ConvertFrom-Json
            $version = $payload.inputs.version
          }
          if (-not $version) { $version = "v$($env:GITHUB_RUN_NUMBER)" }
          # produce a semver without leading 'v' for MSBuild properties
          $semver = $version
          if ($semver.StartsWith('v')) { $semver = $semver.Substring(1) }
          Write-Output "Determined version: $version (semver: $semver)"
          echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "semver=$semver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Restore
        run: dotnet restore OSMBScriptManager/OSMBScriptManager.csproj

      - name: Build + Publish (win-x64)
        run: |
          $ver = "${{ steps.set_version.outputs.semver }}"
          Write-Output "Publishing with Version: $ver"
          dotnet publish OSMBScriptManager/OSMBScriptManager.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true /p:PublishTrimmed=false /p:Version=$ver /p:FileVersion=$ver /p:AssemblyVersion=$ver -o ./publish/win-x64

      - name: Generate changelog
        id: generate_changelog
        shell: pwsh
        run: |
          $version = "${{ steps.set_version.outputs.version }}"
          # ensure tags are present
          git fetch --tags || true
          $prev = git tag --sort=-creatordate | Where-Object { $_ -ne $version } | Select-Object -First 1
          if ($prev) {
            $range = "$prev..$version"
            $notes = git log $range --pretty=format:'- %s (%h)'
          } else {
            $notes = git log -n 50 --pretty=format:'- %s (%h)'
          }
          if (-not $notes) { $notes = "No changelog available." }
          $notes | Out-File -FilePath changelog.txt -Encoding utf8
          echo "notes<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          $notes | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Build installer
        shell: pwsh
        run: |
          $version = "${{ steps.set_version.outputs.version }}"
          pwsh -NoProfile -ExecutionPolicy Bypass -File Installer/build-installer.ps1 -Version $version

      - name: Compute checksums
        id: checksums
        shell: pwsh
        run: |
          $version = "${{ steps.set_version.outputs.version }}"
          $installer = "Installer/Output/OSMBScriptManager-Setup-$version-win-x64.exe"
          $publishDir = "publish/win-x64"
          $exe = Get-ChildItem -Path $publishDir -Filter *.exe -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exe) {
            $exePath = $exe.FullName
            Write-Host "Found published exe: $exePath"
            Get-FileHash -Algorithm SHA256 $exePath | ForEach-Object { $_.Hash } | Out-File ($exePath + ".sha256")
          } else { Write-Host "No published exe found in $publishDir" }
          if (Test-Path $installer) {
            Get-FileHash -Algorithm SHA256 $installer | ForEach-Object { $_.Hash } | Out-File ($installer + ".sha256")
          } else { Write-Host "Installer not found at $installer" }

      - name: Create or get GitHub release
        id: create_or_get_release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ steps.set_version.outputs.version }}"
          $notes = "${{ steps.generate_changelog.outputs.notes }}"
          $repo = $env:GITHUB_REPOSITORY
          $apiGet = "https://api.github.com/repos/$repo/releases/tags/$tag"
          $headers = @{ Authorization = "token $env:GITHUB_TOKEN"; "User-Agent" = "actions" }
          try {
            $existing = Invoke-RestMethod -Uri $apiGet -Headers $headers -Method Get -ErrorAction Stop
            $upload = $existing.upload_url
            Write-Host "Found existing release for $tag"
          }
          catch {
            Write-Host "No existing release, creating one for $tag"
            $createApi = "https://api.github.com/repos/$repo/releases"
            $body = @{ tag_name = $tag; name = "Release $tag"; body = $notes; draft = $false; prerelease = $false } | ConvertTo-Json -Depth 10
            $created = Invoke-RestMethod -Uri $createApi -Headers $headers -Method Post -Body $body -ContentType "application/json"
            $upload = $created.upload_url
          }
          echo "upload_url=$upload" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload installer to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_or_get_release.outputs.upload_url }}
          asset_path: Installer/Output/OSMBScriptManager-Setup-${{ steps.set_version.outputs.version }}-win-x64.exe
          asset_name: OSMBScriptManager-Setup-${{ steps.set_version.outputs.version }}-win-x64.exe
          asset_content_type: application/octet-stream

      - name: Upload installer checksum
        if: always()
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_or_get_release.outputs.upload_url }}
          asset_path: Installer/Output/OSMBScriptManager-Setup-${{ steps.set_version.outputs.version }}-win-x64.exe.sha256
          asset_name: OSMBScriptManager-Setup-${{ steps.set_version.outputs.version }}-win-x64.exe.sha256
          asset_content_type: text/plain

      - name: Find published exe
        id: find_published_exe
        shell: pwsh
        run: |
          $publishDir = "publish/win-x64"
          $exe = Get-ChildItem -Path $publishDir -Filter *.exe -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exe) {
            Write-Host "Found published exe: $($exe.FullName)"
            echo "exe_path=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            $sha = $exe.FullName + ".sha256"
            if (Test-Path $sha) { echo "exe_sha_path=$sha" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append } else { echo "exe_sha_path=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append }
          } else {
            Write-Host "No published exe found"
            echo "exe_path=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            echo "exe_sha_path=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Upload published exe (if present)
        if: ${{ steps.find_published_exe.outputs.exe_path != '' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_or_get_release.outputs.upload_url }}
          asset_path: ${{ steps.find_published_exe.outputs.exe_path }}
          asset_name: OSMBScriptManager-published.exe
          asset_content_type: application/octet-stream

      - name: Upload published exe checksum (if present)
        if: ${{ steps.find_published_exe.outputs.exe_sha_path != '' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_or_get_release.outputs.upload_url }}
          asset_path: ${{ steps.find_published_exe.outputs.exe_sha_path }}
          asset_name: OSMBScriptManager-published.exe.sha256
          asset_content_type: text/plain

