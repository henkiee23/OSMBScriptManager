name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to use when manually triggering'
        required: false

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Determine version
        id: set_version
        shell: pwsh
        run: |
          $version = $null
          if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $version = $matches[1] }
          elseif ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $payload = Get-Content $env:GITHUB_EVENT_PATH | ConvertFrom-Json
            $version = $payload.inputs.version
          }
          if (-not $version) { $version = "v$($env:GITHUB_RUN_NUMBER)" }
          # produce a semver without leading 'v' for MSBuild properties
          $semver = $version
          if ($semver.StartsWith('v')) { $semver = $semver.Substring(1) }
          Write-Output "Determined version: $version (semver: $semver)"
          echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "semver=$semver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Restore
        run: dotnet restore OSMBScriptManager/OSMBScriptManager.csproj

      - name: Build + Publish (win-x64)
        run: |
          $ver = "${{ steps.set_version.outputs.semver }}"
          Write-Output "Publishing with Version: $ver"
          dotnet publish OSMBScriptManager/OSMBScriptManager.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true /p:PublishTrimmed=false /p:Version=$ver /p:FileVersion=$ver /p:AssemblyVersion=$ver -o ./publish/win-x64

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Build installer
        shell: pwsh
        run: |
          $version = "${{ steps.set_version.outputs.version }}"
          pwsh -NoProfile -ExecutionPolicy Bypass -File Installer/build-installer.ps1 -Version $version

      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        with:
          token: ${{ secrets.TOKEN }}
          tag_name: ${{ steps.set_version.outputs.version }}
          release_name: Release ${{ steps.set_version.outputs.version }}
          draft: false
          prerelease: false

      - name: Upload installer to release
        uses: actions/upload-release-asset@v1
        with:
          token: ${{ secrets.TOKEN }}
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: Installer/Output/OSMBScriptManager-Setup-${{ steps.set_version.outputs.version }}-win-x64.exe
          asset_name: OSMBScriptManager-Setup-${{ steps.set_version.outputs.version }}-win-x64.exe
          asset_content_type: application/octet-stream
